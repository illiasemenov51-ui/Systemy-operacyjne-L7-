
#include <iostream>
#include <string>
#include "semaphore.h"

int const threadsCounts = 3;

int const totalNumberOfLettersA = 20;
int const totalNumberOfLettersB = 20;
int const totalNumberOfLettersC = 20;

std::string s;

// ====== SEMAPHORES ======
// Wariant podstawowy ABCABC...
Semaphore semA(1);
Semaphore semB(0);
Semaphore semC(0);

/*
// ====== Wariant zaawansowany 1 (CABCABC...) ======
Semaphore semA(0);
Semaphore semB(0);
Semaphore semC(1);
*/

void writeA()
{
    semA.p();
    std::cout << "A" << std::flush;
    s += "A";
    semB.v();
}

void writeB()
{
    semB.p();
    std::cout << "B" << std::flush;
    s += "B";
    semC.v();
}

void writeC()
{
    semC.p();
    std::cout << "C" << std::flush;
    s += "C";
    semA.v();
}

void* threadA(void* arg)
{
    for (int i = 0; i < totalNumberOfLettersA; ++i)
        writeA();
    return NULL;
}

void* threadB(void* arg)
{
    for (int i = 0; i < totalNumberOfLettersB; ++i)
        writeB();
    return NULL;
}

void* threadC(void* arg)
{
    for (int i = 0; i < totalNumberOfLettersC; ++i)
        writeC();
    return NULL;
}

int main()
{
    std::cout << "  " << std::flush;

#ifdef _WIN32
    HANDLE tid[threadsCounts];
    DWORD id;

    tid[0] = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)threadA, 0, 0, &id);
    tid[1] = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)threadB, 0, 0, &id);
    tid[2] = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)threadC, 0, 0, &id);

    for (int i = 0; i < threadsCounts; i++)
        WaitForSingleObject(tid[i], INFINITE);
#else
    pthread_t tid[threadsCounts];

    pthread_create(&tid[0], NULL, threadA, NULL);
    pthread_create(&tid[1], NULL, threadB, NULL);
    pthread_create(&tid[2], NULL, threadC, NULL);

    for (int i = 0; i < threadsCounts; i++)
        pthread_join(tid[i], NULL);
#endif

    std::cout << "\n";
    std::cout << "s=" << s << "\n";
    return 0;
}
